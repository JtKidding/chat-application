<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>уЙцухёу«Ауљє - УЂітцЕТЄЅућеуеІт╝Ј</title>
    <link rel="stylesheet" href="/css/groups.css">
</head>
<body>
    <div class="groups-container">
        <!-- жаѓжЃет░јУѕф -->
        <nav class="top-nav">
            <div class="nav-left">
                <a href="/home" class="back-btn">Рєљ У┐ћтЏъждќжаЂ</a>
                <h2>уЙцухёу«Ауљє</h2>
            </div>
            <div class="nav-right">
                <a href="/invitations" class="btn btn-secondary" style="position: relative;">
                    ­ЪЊе жѓђУФІжђџуЪЦ
                    <span class="notification-badge" id="groupsInvitationCount" style="display: none;"></span>
                </a>
                <a href="/groups/create" class="btn btn-primary">тЅхт╗║уЙцухё</a>
            </div>
        </nav>

        <!-- Тљют░ІтЇђтЪЪ -->
        <div class="search-section">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Тљют░ІуЙцухё..." />
                <button onclick="searchGroups()" class="search-btn">Тљют░І</button>
            </div>
        </div>

        <!-- ТеЎу▒цжаЂ -->
        <div class="tabs">
            <button class="tab-btn active" onclick="showTab('my-groups')">ТѕЉуџёуЙцухё</button>
            <button class="tab-btn" onclick="showTab('created-groups')">ТѕЉтЅхт╗║уџё</button>
            <button class="tab-btn" onclick="showTab('public-groups')">тЁгжќІуЙцухё</button>
            <button class="tab-btn" onclick="showTab('search-results')" id="search-tab" style="display: none;">Тљют░ІухљТъю</button>
        </div>

        <!-- ТѕЉуџёуЙцухё -->
        <div id="my-groups" class="tab-content active">
            <div class="groups-grid">
                <div th:each="group : ${userGroups}" class="group-card">
                    <div class="group-header">
                        <img th:src="${group.avatarUrl != null ? '/uploads/groups/' + group.avatarUrl.substring(group.avatarUrl.lastIndexOf('/') + 1) : '/images/default-group.png'}"
                             alt="уЙцухёжаГтЃЈ" class="group-avatar">
                        <div class="group-info">
                            <h3 th:text="${group.name}"></h3>
                            <p class="group-members" th:text="${group.members.size()} + ' СйЇТѕљтЊА'"></p>
                            <p class="group-type" th:text="${group.private ? 'уДЂС║║уЙцухё' : 'тЁгжќІуЙцухё'}"></p>
                        </div>
                        <div class="group-status">
                            <span th:if="${group.creator.username == currentUser.username}" class="creator-badge">тЅхт╗║УђЁ</span>
                            <span th:unless="${group.creator.username == currentUser.username}" class="member-badge">ТѕљтЊА</span>
                        </div>
                    </div>

                    <p class="group-description" th:text="${group.description ?: 'Т▓њТюЅТЈЈУ┐░'}"></p>

                    <div class="group-actions">
                        <a th:href="@{/group/{id}(id=${group.id})}" class="btn btn-primary">жђ▓тЁЦУЂітцЕ</a>

                        <!-- тЅхт╗║УђЁтЈ»С╗ЦуюІтѕ░УеГт«џТїЅжѕЋ -->
                        <a th:if="${group.creator.username == currentUser.username}"
                           th:href="@{/groups/{id}/settings(id=${group.id})}"
                           class="btn btn-secondary">УеГт«џ</a>

                        <!-- жЮътЅхт╗║УђЁтЈ»С╗ЦуюІтѕ░жЏбжќІТїЅжѕЋ -->
                        <button th:unless="${group.creator.username == currentUser.username}"
                                th:onclick="'confirmLeaveGroupFromList(' + ${group.id} + ', \'' + ${group.name} + '\')'"
                                class="btn btn-danger">жЏбжќІ</button>
                    </div>
                </div>

                <div th:if="${#lists.isEmpty(userGroups)}" class="empty-state">
                    <div class="empty-icon">­ЪЉЦ</div>
                    <h3>жѓёТ▓њТюЅтіатЁЦС╗╗СйЋуЙцухё</h3>
                    <p>тЅхт╗║Тќ░уЙцухёТѕќтіатЁЦуЈЙТюЅуЙцухёжќІтДІУЂітцЕ</p>
                    <a href="/groups/create" class="btn btn-primary">тЅхт╗║уЙцухё</a>
                </div>
            </div>
        </div>

        <!-- ТѕЉтЅхт╗║уџёуЙцухё -->
        <div id="created-groups" class="tab-content">
            <div class="groups-grid">
                <div th:each="group : ${createdGroups}" class="group-card creator-card">
                    <div class="group-header">
                        <img th:src="${group.avatarUrl != null ? '/uploads/groups/' + group.avatarUrl.substring(group.avatarUrl.lastIndexOf('/') + 1) : '/images/default-group.png'}"
                             alt="уЙцухёжаГтЃЈ" class="group-avatar">
                        <div class="group-info">
                            <h3 th:text="${group.name}"></h3>
                            <p class="group-members" th:text="${group.members.size()} + ' СйЇТѕљтЊА'"></p>
                            <p class="group-created" th:text="'тЅхт╗║Тќ╝ ' + ${#temporals.format(group.createdAt, 'yyyy-MM-dd')}"></p>
                        </div>
                        <div class="creator-badge">тЅхт╗║УђЁ</div>
                    </div>

                    <p class="group-description" th:text="${group.description ?: 'Т▓њТюЅТЈЈУ┐░'}"></p>

                    <div class="group-stats">
                        <div class="stat-item">
                            <span class="stat-number" th:text="${group.members.size()}"></span>
                            <span class="stat-label">ТѕљтЊА</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number" th:text="${group.private ? 'уДЂС║║' : 'тЁгжќІ'}"></span>
                            <span class="stat-label">жАътъІ</span>
                        </div>
                    </div>

                    <div class="group-actions">
                        <a th:href="@{/group/{id}(id=${group.id})}" class="btn btn-primary">жђ▓тЁЦУЂітцЕ</a>
                        <a th:href="@{/groups/{id}/settings(id=${group.id})}" class="btn btn-secondary">у«Ауљє</a>
                    </div>
                </div>

                <div th:if="${#lists.isEmpty(createdGroups)}" class="empty-state">
                    <div class="empty-icon">РъЋ</div>
                    <h3>жѓёТ▓њТюЅтЅхт╗║С╗╗СйЋуЙцухё</h3>
                    <p>тЅхт╗║ТѓеуџёуггСИђтђІуЙцухёжќІтДІу«Ауљє</p>
                    <a href="/groups/create" class="btn btn-primary">тЅхт╗║уЙцухё</a>
                </div>
            </div>
        </div>

        <!-- тЁгжќІуЙцухё -->
        <div id="public-groups" class="tab-content">
            <div class="groups-grid">
                <div th:each="group : ${publicGroups}" class="group-card public-card">
                    <div class="group-header">
                        <img th:src="${group.avatarUrl != null ? '/uploads/groups/' + group.avatarUrl.substring(group.avatarUrl.lastIndexOf('/') + 1) : '/images/default-group.png'}"
                             alt="уЙцухёжаГтЃЈ" class="group-avatar">
                        <div class="group-info">
                            <h3 th:text="${group.name}"></h3>
                            <p class="group-members" th:text="${group.members.size()} + ' СйЇТѕљтЊА'"></p>
                            <p class="group-creator" th:text="'тЅхт╗║УђЁ№╝џ' + ${group.creator.displayName}"></p>
                        </div>
                        <div class="public-badge">тЁгжќІ</div>
                    </div>

                    <p class="group-description" th:text="${group.description ?: 'Т▓њТюЅТЈЈУ┐░'}"></p>

                    <div class="group-actions">
                        <!-- С┐«Тћ╣№╝џтЁѕжаљУдйтєЇтіатЁЦ -->
                        <a th:href="@{/group/{id}/preview(id=${group.id})}" class="btn btn-secondary">жаљУдйуЙцухё</a>
                        <form th:action="@{/groups/{id}/join(id=${group.id})}" method="post" style="display: inline;">
                            <button type="submit" class="btn btn-primary">уЏ┤ТјЦтіатЁЦ</button>
                        </form>
                    </div>
                </div>

                <div th:if="${#lists.isEmpty(publicGroups)}" class="empty-state">
                    <div class="empty-icon">­ЪћЇ</div>
                    <h3>Т▓њТюЅТЅЙтѕ░тЁгжќІуЙцухё</h3>
                    <p>уЏ«тЅЇТ▓њТюЅтЈ»тіатЁЦуџётЁгжќІуЙцухё</p>
                </div>
            </div>
        </div>

        <!-- Тљют░ІухљТъю -->
        <div id="search-results" class="tab-content">
            <div class="groups-grid" id="searchResultsContainer">
                <!-- Тљют░ІухљТъюТюЃтюежђЎУБАжА»уц║ -->
            </div>
        </div>
    </div>

    <script>
        function confirmLeaveGroupFromList(groupId, groupName) {
            if (confirm(`Рџа№ИЈ уб║т«џУдЂжЏбжќІуЙцухёсђї${groupName}сђЇтЌј№╝Ъ\n\nжЏбжќІтЙїТѓет░ЄуёАТ│ЋтєЇТјЦТћХуЙцухёУеіТЂ»сђѓ`)) {
                leaveGroupFromList(groupId, groupName);
            }
        }

        function leaveGroupFromList(groupId, groupName) {
            const leaveBtn = document.querySelector(`button[onclick*="confirmLeaveGroupFromList(${groupId}"]`);
            if (leaveBtn) {
                leaveBtn.textContent = 'УЎЋуљєСИГ...';
                leaveBtn.disabled = true;
            }

            fetch(`/api/groups/${groupId}/leave`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
                .then(response => {
                    if (response.ok) {
                        return response.json().then(data => {
                            alert(`РюЁ ${data.message || 'ти▓ТѕљтіЪжЏбжќІуЙцухё'}`);
                            // жЄЇТќ░У╝ЅтЁЦжаЂжЮбС╗ЦТЏ┤Тќ░уЙцухётѕЌУАе
                            window.location.reload();
                        });
                    } else {
                        return response.json().then(errorData => {
                            throw new Error(errorData.error || 'жЏбжќІуЙцухётц▒ТЋЌ');
                        });
                    }
                })
                .catch(error => {
                    console.error('жЏбжќІуЙцухёжї»Уфц:', error);
                    alert('РЮї жЏбжќІуЙцухётц▒ТЋЌ: ' + error.message);

                    if (leaveBtn) {
                        leaveBtn.textContent = 'жЏбжќІ';
                        leaveBtn.disabled = false;
                    }
                });
        }

        // ТеЎу▒цжаЂтѕЄТЈЏ
        function showTab(tabName) {
            // жџ▒УЌЈТЅђТюЅТеЎу▒цтЁДт«╣
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => content.classList.remove('active'));

            // уД╗жЎцТЅђТюЅТеЎу▒цТїЅжѕЋуџёactiveжАъ
            const tabButtons = document.querySelectorAll('.tab-btn');
            tabButtons.forEach(btn => btn.classList.remove('active'));

            // жА»уц║жЂИСИГуџёТеЎу▒цтЁДт«╣
            document.getElementById(tabName).classList.add('active');

            // Т┐ђТ┤╗т░ЇТЄЅуџёТеЎу▒цТїЅжѕЋ
            event.target.classList.add('active');
        }

        // Тљют░ІуЙцухётіЪУЃй
        function searchGroups() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) {
                alert('УФІУ╝ИтЁЦТљют░ІжЌюжЇхтГЌ');
                return;
            }

            fetch(`/api/groups/search?query=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(groups => {
                    displaySearchResults(groups);
                    showSearchTab();
                })
                .catch(error => {
                    console.error('Тљют░Ітц▒ТЋЌ:', error);
                    alert('Тљют░Ітц▒ТЋЌ№╝їУФІуеЇтЙїтєЇУЕд');
                });
        }

        // жА»уц║Тљют░ІухљТъю
        function displaySearchResults(groups) {
            const container = document.getElementById('searchResultsContainer');

            if (groups.length === 0) {
                container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">­ЪћЇ</div>
                            <h3>Т▓њТюЅТЅЙтѕ░уЏИжЌюуЙцухё</h3>
                            <p>тўЌУЕдСй┐ућеСИЇтљїуџёжЌюжЇхтГЌТљют░І</p>
                        </div>
                    `;
                return;
            }

            const groupsHTML = groups.map(group => `
                    <div class="group-card public-card">
                        <div class="group-header">
                            <img src="${group.avatarUrl}" alt="уЙцухёжаГтЃЈ" class="group-avatar">
                            <div class="group-info">
                                <h3>${group.name}</h3>
                                <p class="group-members">${group.memberCount} СйЇТѕљтЊА</p>
                            </div>
                            <div class="public-badge">тЁгжќІ</div>
                        </div>
                        <p class="group-description">${group.description || 'Т▓њТюЅТЈЈУ┐░'}</p>
                        <div class="group-actions">
                            ${group.isMember ?
                `<a href="/group/${group.id}" class="btn btn-primary">жђ▓тЁЦУЂітцЕ</a>` :
                `<form action="/groups/${group.id}/join" method="post" style="display: inline;">
                                    <button type="submit" class="btn btn-primary">тіатЁЦуЙцухё</button>
                                </form>`
            }
                        </div>
                    </div>
                `).join('');

            container.innerHTML = `<div class="groups-grid">${groupsHTML}</div>`;
        }

        // жА»уц║Тљют░ІТеЎу▒ц
        function showSearchTab() {
            document.getElementById('search-tab').style.display = 'inline-block';
            showTab('search-results');

            // ТЏ┤Тќ░ТеЎу▒цТїЅжѕЋуІђТЁІ
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('search-tab').classList.add('active');
        }

        // EnterжЇхТљют░І
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchGroups();
            }
        });

        // У╝ЅтЁЦжѓђУФІжђџуЪЦТЋИжЄЈ
        function loadGroupsInvitationNotifications() {
            fetch('/api/invitations/stats')
                .then(response => response.json())
                .then(stats => {
                    const badge = document.getElementById('groupsInvitationCount');
                    if (stats.pendingCount > 0) {
                        badge.textContent = stats.pendingCount;
                        badge.style.display = 'inline-block';
                        badge.style.position = 'absolute';
                        badge.style.top = '-8px';
                        badge.style.right = '-8px';
                        badge.style.background = '#dc3545';
                        badge.style.color = 'white';
                        badge.style.fontSize = '0.7rem';
                        badge.style.padding = '0.2rem 0.5rem';
                        badge.style.borderRadius = '10px';
                        badge.style.minWidth = '18px';
                        badge.style.textAlign = 'center';
                        badge.style.fontWeight = '600';
                    } else {
                        badge.style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error('У╝ЅтЁЦжѓђУФІжђџуЪЦтц▒ТЋЌ:', error);
                });
        }

        // жаЂжЮбУ╝ЅтЁЦТЎѓтЪиУАї
        document.addEventListener('DOMContentLoaded', function() {
            loadGroupsInvitationNotifications();
        });
    </script>
</body>
</html>