<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¾¤çµ„ç®¡ç† - èŠå¤©æ‡‰ç”¨ç¨‹å¼</title>
    <link rel="stylesheet" href="/css/groups.css">
</head>
<body>
    <div class="groups-container">
        <!-- é ‚éƒ¨å°èˆª -->
        <nav class="top-nav">
            <div class="nav-left">
                <a href="/home" class="back-btn">â† è¿”å›é¦–é </a>
                <h2>ç¾¤çµ„ç®¡ç†</h2>
            </div>
            <div class="nav-right">
                <a href="/invitations" class="btn btn-secondary" style="position: relative;">
                    ğŸ“¨ é‚€è«‹é€šçŸ¥
                    <span class="notification-badge" id="groupsInvitationCount" style="display: none;"></span>
                </a>
                <a href="/groups/create" class="btn btn-primary">å‰µå»ºç¾¤çµ„</a>
            </div>
        </nav>

        <!-- æœå°‹å€åŸŸ -->
        <div class="search-section">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="æœå°‹ç¾¤çµ„..." />
                <button onclick="searchGroups()" class="search-btn">æœå°‹</button>
            </div>
        </div>

        <!-- æ¨™ç±¤é  -->
        <div class="tabs">
            <button class="tab-btn active" onclick="showTab('my-groups')">æˆ‘çš„ç¾¤çµ„</button>
            <button class="tab-btn" onclick="showTab('created-groups')">æˆ‘å‰µå»ºçš„</button>
            <button class="tab-btn" onclick="showTab('public-groups')">å…¬é–‹ç¾¤çµ„</button>
            <button class="tab-btn" onclick="showTab('search-results')" id="search-tab" style="display: none;">æœå°‹çµæœ</button>
        </div>

        <!-- æˆ‘çš„ç¾¤çµ„ -->
        <div id="my-groups" class="tab-content active">
            <div class="groups-grid">
                <div th:each="group : ${userGroups}" class="group-card">
                    <div class="group-header">
                        <img th:src="${group.avatarUrl != null ? '/uploads/groups/' + group.avatarUrl.substring(group.avatarUrl.lastIndexOf('/') + 1) : '/images/default-group.png'}"
                             alt="ç¾¤çµ„é ­åƒ" class="group-avatar">
                        <div class="group-info">
                            <h3 th:text="${group.name}"></h3>
                            <p class="group-members" th:text="${group.members.size()} + ' ä½æˆå“¡'"></p>
                            <p class="group-type" th:text="${group.private ? 'ç§äººç¾¤çµ„' : 'å…¬é–‹ç¾¤çµ„'}"></p>
                        </div>
                        <div class="group-status">
                            <span th:if="${group.creator.username == currentUser.username}" class="creator-badge">å‰µå»ºè€…</span>
                            <span th:unless="${group.creator.username == currentUser.username}" class="member-badge">æˆå“¡</span>
                        </div>
                    </div>

                    <p class="group-description" th:text="${group.description ?: 'æ²’æœ‰æè¿°'}"></p>

                    <div class="group-actions">
                        <a th:href="@{/group/{id}(id=${group.id})}" class="btn btn-primary">é€²å…¥èŠå¤©</a>

                        <!-- å‰µå»ºè€…å¯ä»¥çœ‹åˆ°è¨­å®šæŒ‰éˆ• -->
                        <a th:if="${group.creator.username == currentUser.username}"
                           th:href="@{/groups/{id}/settings(id=${group.id})}"
                           class="btn btn-secondary">è¨­å®š</a>

                        <!-- éå‰µå»ºè€…å¯ä»¥çœ‹åˆ°é›¢é–‹æŒ‰éˆ• -->
                        <button th:unless="${group.creator.username == currentUser.username}"
                                th:onclick="'confirmLeaveGroupFromList(' + ${group.id} + ', \'' + ${group.name} + '\')'"
                                class="btn btn-danger">é›¢é–‹</button>
                    </div>
                </div>

                <div th:if="${#lists.isEmpty(userGroups)}" class="empty-state">
                    <div class="empty-icon">ğŸ‘¥</div>
                    <h3>é‚„æ²’æœ‰åŠ å…¥ä»»ä½•ç¾¤çµ„</h3>
                    <p>å‰µå»ºæ–°ç¾¤çµ„æˆ–åŠ å…¥ç¾æœ‰ç¾¤çµ„é–‹å§‹èŠå¤©</p>
                    <a href="/groups/create" class="btn btn-primary">å‰µå»ºç¾¤çµ„</a>
                </div>
            </div>
        </div>

        <!-- æˆ‘å‰µå»ºçš„ç¾¤çµ„ -->
        <div id="created-groups" class="tab-content">
            <div class="groups-grid">
                <div th:each="group : ${createdGroups}" class="group-card creator-card">
                    <div class="group-header">
                        <img th:src="${group.avatarUrl != null ? '/uploads/groups/' + group.avatarUrl.substring(group.avatarUrl.lastIndexOf('/') + 1) : '/images/default-group.png'}"
                             alt="ç¾¤çµ„é ­åƒ" class="group-avatar">
                        <div class="group-info">
                            <h3 th:text="${group.name}"></h3>
                            <p class="group-members" th:text="${group.members.size()} + ' ä½æˆå“¡'"></p>
                            <p class="group-created" th:text="'å‰µå»ºæ–¼ ' + ${#temporals.format(group.createdAt, 'yyyy-MM-dd')}"></p>
                        </div>
                        <div class="creator-badge">å‰µå»ºè€…</div>
                    </div>

                    <p class="group-description" th:text="${group.description ?: 'æ²’æœ‰æè¿°'}"></p>

                    <div class="group-stats">
                        <div class="stat-item">
                            <span class="stat-number" th:text="${group.members.size()}"></span>
                            <span class="stat-label">æˆå“¡</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number" th:text="${group.private ? 'ç§äºº' : 'å…¬é–‹'}"></span>
                            <span class="stat-label">é¡å‹</span>
                        </div>
                    </div>

                    <div class="group-actions">
                        <a th:href="@{/group/{id}(id=${group.id})}" class="btn btn-primary">é€²å…¥èŠå¤©</a>
                        <a th:href="@{/groups/{id}/settings(id=${group.id})}" class="btn btn-secondary">ç®¡ç†</a>
                    </div>
                </div>

                <div th:if="${#lists.isEmpty(createdGroups)}" class="empty-state">
                    <div class="empty-icon">â•</div>
                    <h3>é‚„æ²’æœ‰å‰µå»ºä»»ä½•ç¾¤çµ„</h3>
                    <p>å‰µå»ºæ‚¨çš„ç¬¬ä¸€å€‹ç¾¤çµ„é–‹å§‹ç®¡ç†</p>
                    <a href="/groups/create" class="btn btn-primary">å‰µå»ºç¾¤çµ„</a>
                </div>
            </div>
        </div>

        <!-- å…¬é–‹ç¾¤çµ„ -->
        <div id="public-groups" class="tab-content">
            <div class="groups-grid">
                <div th:each="group : ${publicGroups}" class="group-card public-card">
                    <div class="group-header">
                        <img th:src="${group.avatarUrl != null ? '/uploads/groups/' + group.avatarUrl.substring(group.avatarUrl.lastIndexOf('/') + 1) : '/images/default-group.png'}"
                             alt="ç¾¤çµ„é ­åƒ" class="group-avatar">
                        <div class="group-info">
                            <h3 th:text="${group.name}"></h3>
                            <p class="group-members" th:text="${group.members.size()} + ' ä½æˆå“¡'"></p>
                            <p class="group-creator" th:text="'å‰µå»ºè€…ï¼š' + ${group.creator.displayName}"></p>
                        </div>
                        <div class="public-badge">å…¬é–‹</div>
                    </div>

                    <p class="group-description" th:text="${group.description ?: 'æ²’æœ‰æè¿°'}"></p>

                    <div class="group-actions">
                        <!-- ä¿®æ”¹ï¼šå…ˆé è¦½å†åŠ å…¥ -->
                        <a th:href="@{/group/{id}/preview(id=${group.id})}" class="btn btn-secondary">é è¦½ç¾¤çµ„</a>
                        <form th:action="@{/groups/{id}/join(id=${group.id})}" method="post" style="display: inline;">
                            <button type="submit" class="btn btn-primary">ç›´æ¥åŠ å…¥</button>
                        </form>
                    </div>
                </div>

                <div th:if="${#lists.isEmpty(publicGroups)}" class="empty-state">
                    <div class="empty-icon">ğŸ”</div>
                    <h3>æ²’æœ‰æ‰¾åˆ°å…¬é–‹ç¾¤çµ„</h3>
                    <p>ç›®å‰æ²’æœ‰å¯åŠ å…¥çš„å…¬é–‹ç¾¤çµ„</p>
                </div>
            </div>
        </div>

        <!-- æœå°‹çµæœ -->
        <div id="search-results" class="tab-content">
            <div class="groups-grid" id="searchResultsContainer">
                <!-- æœå°‹çµæœæœƒåœ¨é€™è£¡é¡¯ç¤º -->
            </div>
        </div>
    </div>

    <script>
        function confirmLeaveGroupFromList(groupId, groupName) {
            if (confirm(`âš ï¸ ç¢ºå®šè¦é›¢é–‹ç¾¤çµ„ã€Œ${groupName}ã€å—ï¼Ÿ\n\né›¢é–‹å¾Œæ‚¨å°‡ç„¡æ³•å†æ¥æ”¶ç¾¤çµ„è¨Šæ¯ã€‚`)) {
                leaveGroupFromList(groupId, groupName);
            }
        }

        function leaveGroupFromList(groupId, groupName) {
            const leaveBtn = document.querySelector(`button[onclick*="confirmLeaveGroupFromList(${groupId}"]`);
            if (leaveBtn) {
                leaveBtn.textContent = 'è™•ç†ä¸­...';
                leaveBtn.disabled = true;
            }

            fetch(`/api/groups/${groupId}/leave`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
                .then(response => {
                    if (response.ok) {
                        return response.json().then(data => {
                            alert(`âœ… ${data.message || 'å·²æˆåŠŸé›¢é–‹ç¾¤çµ„'}`);
                            // é‡æ–°è¼‰å…¥é é¢ä»¥æ›´æ–°ç¾¤çµ„åˆ—è¡¨
                            window.location.reload();
                        });
                    } else {
                        return response.json().then(errorData => {
                            throw new Error(errorData.error || 'é›¢é–‹ç¾¤çµ„å¤±æ•—');
                        });
                    }
                })
                .catch(error => {
                    console.error('é›¢é–‹ç¾¤çµ„éŒ¯èª¤:', error);
                    alert('âŒ é›¢é–‹ç¾¤çµ„å¤±æ•—: ' + error.message);

                    if (leaveBtn) {
                        leaveBtn.textContent = 'é›¢é–‹';
                        leaveBtn.disabled = false;
                    }
                });
        }

        // æ¨™ç±¤é åˆ‡æ›
        function showTab(tabName) {
            // éš±è—æ‰€æœ‰æ¨™ç±¤å…§å®¹
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => content.classList.remove('active'));

            // ç§»é™¤æ‰€æœ‰æ¨™ç±¤æŒ‰éˆ•çš„activeé¡
            const tabButtons = document.querySelectorAll('.tab-btn');
            tabButtons.forEach(btn => btn.classList.remove('active'));

            // é¡¯ç¤ºé¸ä¸­çš„æ¨™ç±¤å…§å®¹
            document.getElementById(tabName).classList.add('active');

            // æ¿€æ´»å°æ‡‰çš„æ¨™ç±¤æŒ‰éˆ•
            event.target.classList.add('active');
        }

        // æœå°‹ç¾¤çµ„åŠŸèƒ½
        function searchGroups() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) {
                alert('è«‹è¼¸å…¥æœå°‹é—œéµå­—');
                return;
            }

            fetch(`/api/groups/search?query=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(groups => {
                    displaySearchResults(groups);
                    showSearchTab();
                })
                .catch(error => {
                    console.error('æœå°‹å¤±æ•—:', error);
                    alert('æœå°‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
                });
        }

        // é¡¯ç¤ºæœå°‹çµæœ
        function displaySearchResults(groups) {
            const container = document.getElementById('searchResultsContainer');

            if (groups.length === 0) {
                container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">ğŸ”</div>
                            <h3>æ²’æœ‰æ‰¾åˆ°ç›¸é—œç¾¤çµ„</h3>
                            <p>å˜—è©¦ä½¿ç”¨ä¸åŒçš„é—œéµå­—æœå°‹</p>
                        </div>
                    `;
                return;
            }

            const groupsHTML = groups.map(group => `
                    <div class="group-card public-card">
                        <div class="group-header">
                            <img src="${group.avatarUrl}" alt="ç¾¤çµ„é ­åƒ" class="group-avatar">
                            <div class="group-info">
                                <h3>${group.name}</h3>
                                <p class="group-members">${group.memberCount} ä½æˆå“¡</p>
                            </div>
                            <div class="public-badge">å…¬é–‹</div>
                        </div>
                        <p class="group-description">${group.description || 'æ²’æœ‰æè¿°'}</p>
                        <div class="group-actions">
                            ${group.isMember ?
                `<a href="/group/${group.id}" class="btn btn-primary">é€²å…¥èŠå¤©</a>` :
                `<form action="/groups/${group.id}/join" method="post" style="display: inline;">
                                    <button type="submit" class="btn btn-primary">åŠ å…¥ç¾¤çµ„</button>
                                </form>`
            }
                        </div>
                    </div>
                `).join('');

            container.innerHTML = `<div class="groups-grid">${groupsHTML}</div>`;
        }

        // é¡¯ç¤ºæœå°‹æ¨™ç±¤
        function showSearchTab() {
            document.getElementById('search-tab').style.display = 'inline-block';
            showTab('search-results');

            // æ›´æ–°æ¨™ç±¤æŒ‰éˆ•ç‹€æ…‹
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('search-tab').classList.add('active');
        }

        // Enteréµæœå°‹
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchGroups();
            }
        });

        // è¼‰å…¥é‚€è«‹é€šçŸ¥æ•¸é‡
        function loadGroupsInvitationNotifications() {
            fetch('/api/invitations/stats')
                .then(response => response.json())
                .then(stats => {
                    const badge = document.getElementById('groupsInvitationCount');
                    if (stats.pendingCount > 0) {
                        badge.textContent = stats.pendingCount;
                        badge.style.display = 'inline-block';
                        badge.style.position = 'absolute';
                        badge.style.top = '-8px';
                        badge.style.right = '-8px';
                        badge.style.background = '#dc3545';
                        badge.style.color = 'white';
                        badge.style.fontSize = '0.7rem';
                        badge.style.padding = '0.2rem 0.5rem';
                        badge.style.borderRadius = '10px';
                        badge.style.minWidth = '18px';
                        badge.style.textAlign = 'center';
                        badge.style.fontWeight = '600';
                    } else {
                        badge.style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error('è¼‰å…¥é‚€è«‹é€šçŸ¥å¤±æ•—:', error);
                });
        }

        // é é¢è¼‰å…¥æ™‚åŸ·è¡Œ
        document.addEventListener('DOMContentLoaded', function() {
            loadGroupsInvitationNotifications();
        });
    </script>
</body>
</html>