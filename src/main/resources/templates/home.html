<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¦–é  - èŠå¤©æ‡‰ç”¨ç¨‹å¼</title>
    <link rel="stylesheet" href="/css/home.css">
</head>
<body>
    <div class="home-container">
        <!-- é ‚éƒ¨å°èˆª -->
        <nav class="top-nav">
            <div class="nav-brand">
                <h2>èŠå¤©æ‡‰ç”¨ç¨‹å¼</h2>
            </div>
            <div class="nav-user">
                <img th:src="${currentUser.avatarUrl != null ? '/uploads/avatars/' + currentUser.avatarUrl.substring(currentUser.avatarUrl.lastIndexOf('/') + 1) : '/images/default-avatar.png'}"
                     alt="æˆ‘çš„é ­åƒ" class="nav-avatar">
                <span th:text="${currentUser.displayName}"></span>
                <div class="nav-dropdown">
                    <button class="dropdown-btn">â–¼</button>
                    <div class="dropdown-content">
                        <a href="/invitations">ğŸ“¨ ç¾¤çµ„é‚€è«‹</a>
                        <a href="/profile">å€‹äººè³‡æ–™</a>
                        <a href="/logout">ç™»å‡º</a>
                    </div>
                </div>
            </div>
        </nav>

        <!-- ä¸»è¦å…§å®¹ -->
        <div class="main-content">
            <!-- å·¦å´é‚Šæ¬„ -->
            <aside class="sidebar">
                <div class="sidebar-section">
                    <h3>å¿«é€Ÿå°èˆª</h3>
                    <ul class="nav-links">
                        <li><a href="/chat" class="nav-link">
                            <span class="icon">ğŸ’¬</span>ç§äººèŠå¤©
                        </a></li>
                        <li><a href="/groups" class="nav-link">
                            <span class="icon">ğŸ‘¥</span>ç¾¤çµ„ç®¡ç†
                        </a></li>
                        <li><a href="/groups/create" class="nav-link">
                            <span class="icon">â•</span>å‰µå»ºç¾¤çµ„
                        </a></li>
                        <li><a href="/invitations" class="nav-link">
                            <span class="icon">ğŸ“¨</span>ç¾¤çµ„é‚€è«‹
                            <span class="notification-badge" id="invitationCount" style="display: none;"></span>
                        </a></li>
                    </ul>
                </div>

                <!-- æœ€è¿‘èŠå¤© -->
                <div class="sidebar-section">
                    <h3>æœ€è¿‘èŠå¤©</h3>
                    <div class="recent-chats">
                        <div th:each="partner : ${chatPartners}" class="chat-item">
                            <a th:href="@{/chat}" class="chat-link">
                                <img th:src="${partner.avatarUrl != null ? '/uploads/avatars/' + partner.avatarUrl.substring(partner.avatarUrl.lastIndexOf('/') + 1) : '/images/default-avatar.png'}"
                                     alt="é ­åƒ" class="chat-avatar">
                                <div class="chat-info">
                                    <div class="chat-name" th:text="${partner.displayName}"></div>
                                    <div class="chat-status" th:text="${partner.online ? 'ç·šä¸Š' : 'é›¢ç·š'}"></div>
                                </div>
                            </a>
                        </div>
                        <div th:if="${#lists.isEmpty(chatPartners)}" class="empty-state">
                            <p>é‚„æ²’æœ‰èŠå¤©è¨˜éŒ„</p>
                            <a href="/chat" class="btn btn-primary">é–‹å§‹èŠå¤©</a>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- ä¸»è¦å€åŸŸ -->
            <main class="main-area">
                <!-- æ­¡è¿å€åŸŸ -->
                <section class="welcome-section">
                    <h1>æ­¡è¿å›ä¾†ï¼Œ<span th:text="${currentUser.displayName}"></span>ï¼</h1>
                    <p>é¸æ“‡ä¸€å€‹é¸é …é–‹å§‹ä½¿ç”¨èŠå¤©åŠŸèƒ½</p>

                    <div class="action-cards">
                        <div class="action-card">
                            <div class="card-icon">ğŸ’¬</div>
                            <h3>ç§äººèŠå¤©</h3>
                            <p>èˆ‡å…¶ä»–ç”¨æˆ¶é€²è¡Œä¸€å°ä¸€èŠå¤©</p>
                            <a href="/chat" class="btn btn-primary">é–‹å§‹èŠå¤©</a>
                        </div>

                        <div class="action-card">
                            <div class="card-icon">ğŸ‘¥</div>
                            <h3>ç¾¤çµ„èŠå¤©</h3>
                            <p>åŠ å…¥æˆ–å‰µå»ºç¾¤çµ„é€²è¡Œå¤šäººèŠå¤©</p>
                            <a href="/groups" class="btn btn-secondary">ç®¡ç†ç¾¤çµ„</a>
                        </div>

                        <div class="action-card">
                            <div class="card-icon">âš™ï¸</div>
                            <h3>å€‹äººè¨­å®š</h3>
                            <p>ç®¡ç†æ‚¨çš„å€‹äººè³‡æ–™å’Œè¨­å®š</p>
                            <a href="/profile" class="btn btn-outline">å€‹äººè³‡æ–™</a>
                        </div>
                    </div>
                </section>

                <!-- æˆ‘çš„ç¾¤çµ„ -->
                <section class="groups-section">
                    <div class="section-header">
                        <h2>æˆ‘çš„ç¾¤çµ„</h2>
                        <a href="/groups" class="view-all">æŸ¥çœ‹å…¨éƒ¨</a>
                    </div>

                    <div class="groups-grid">
                        <div th:each="group : ${userGroups}" class="group-card">
                            <div class="group-header">
                                <img th:src="${group.avatarUrl != null ? '/uploads/groups/' + group.avatarUrl.substring(group.avatarUrl.lastIndexOf('/') + 1) : '/images/default-group.png'}"
                                     alt="ç¾¤çµ„é ­åƒ" class="group-avatar">
                                <div class="group-info">
                                    <h4 th:text="${group.name}"></h4>
                                    <p class="group-members" th:text="${group.members.size()} + ' ä½æˆå“¡'"></p>
                                </div>
                            </div>

                            <p class="group-description" th:text="${group.description ?: 'æ²’æœ‰æè¿°'}"></p>

                            <!-- æœ€å¾Œè¨Šæ¯ -->
                            <div th:if="${latestGroupMessages.containsKey(group.id)}" class="last-message">
                                <div class="message-preview" th:with="lastMsg=${latestGroupMessages.get(group.id)}">
                                    <span class="sender" th:text="${lastMsg.sender?.displayName ?: 'ç³»çµ±'}"></span>:
                                    <span class="content" th:text="${lastMsg.content}"></span>
                                </div>
                            </div>

                            <div class="group-actions">
                                <a th:href="@{/group/{id}(id=${group.id})}" class="btn btn-primary btn-sm">é€²å…¥èŠå¤©</a>
                                <a th:if="${group.creator.username == currentUser.username}"
                                   th:href="@{/groups/{id}/settings(id=${group.id})}"
                                   class="btn btn-outline btn-sm">è¨­å®š</a>
                            </div>
                        </div>

                        <div th:if="${#lists.isEmpty(userGroups)}" class="empty-state">
                            <div class="empty-icon">ğŸ‘¥</div>
                            <h3>é‚„æ²’æœ‰åŠ å…¥ä»»ä½•ç¾¤çµ„</h3>
                            <p>å‰µå»ºæ–°ç¾¤çµ„æˆ–åŠ å…¥ç¾æœ‰ç¾¤çµ„é–‹å§‹èŠå¤©</p>
                            <a href="/groups/create" class="btn btn-primary">å‰µå»ºç¾¤çµ„</a>
                        </div>
                    </div>
                </section>

                <!-- æ¨è–¦ç¾¤çµ„ -->
                <section class="recommended-section" th:if="${!#lists.isEmpty(recommendedGroups)}">
                    <div class="section-header">
                        <h2>æ¨è–¦ç¾¤çµ„</h2>
                        <a href="/groups" class="view-all">æŸ¥çœ‹æ›´å¤š</a>
                    </div>

                    <div class="recommended-grid">
                        <div th:each="group : ${recommendedGroups}" class="recommended-card">
                            <img th:src="${group.avatarUrl != null ? '/uploads/groups/' + group.avatarUrl.substring(group.avatarUrl.lastIndexOf('/') + 1) : '/images/default-group.png'}"
                                 alt="ç¾¤çµ„é ­åƒ" class="recommended-avatar">
                            <div class="recommended-info">
                                <h4 th:text="${group.name}"></h4>
                                <p th:text="${group.description ?: 'æ²’æœ‰æè¿°'}"></p>
                                <div class="recommended-meta">
                                    <span th:text="${group.members.size()} + ' ä½æˆå“¡'"></span>
                                </div>
                            </div>
                            <form th:action="@{/groups/{id}/join(id=${group.id})}" method="post" style="display: inline;">
                                <button type="submit" class="btn btn-primary btn-sm">åŠ å…¥</button>
                            </form>
                        </div>
                    </div>
                </section>
            </main>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <script th:inline="javascript">
        var currentUser = /*[[${currentUser.username}]]*/ '';
        var stompClient = null;

        // ä¸‹æ‹‰é¸å–®åŠŸèƒ½
        document.querySelector('.dropdown-btn').addEventListener('click', function() {
            document.querySelector('.dropdown-content').classList.toggle('show');
        });

        // é»æ“Šå¤–éƒ¨é—œé–‰ä¸‹æ‹‰é¸å–®
        window.addEventListener('click', function(event) {
            if (!event.target.matches('.dropdown-btn')) {
                const dropdowns = document.getElementsByClassName('dropdown-content');
                for (let i = 0; i < dropdowns.length; i++) {
                    dropdowns[i].classList.remove('show');
                }
            }
        });
        // è¼‰å…¥é‚€è«‹é€šçŸ¥æ•¸é‡
        function loadInvitationNotifications() {
            fetch('/api/invitations/stats')
                .then(response => response.json())
                .then(stats => {
                    const badge = document.getElementById('invitationCount');
                    if (stats.pendingCount > 0) {
                        badge.textContent = stats.pendingCount;
                        badge.style.display = 'inline-block';
                    } else {
                        badge.style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error('è¼‰å…¥é‚€è«‹é€šçŸ¥å¤±æ•—:', error);
                });
        }

        // å…¨å±€ç·šä¸Šç‹€æ…‹ç®¡ç†
        function initializeGlobalStatus() {
            console.log('åˆå§‹åŒ–å…¨å±€ç·šä¸Šç‹€æ…‹ç®¡ç†...');

            const socket = new SockJS('/ws');
            stompClient = Stomp.over(socket);

            stompClient.connect({}, function(frame) {
                console.log('å…¨å±€ WebSocket é€£æ¥æˆåŠŸ:', frame);

                // è¨‚é–±ç”¨æˆ¶ç‹€æ…‹æ›´æ–°
                stompClient.subscribe('/topic/public', function(message) {
                    const messageData = JSON.parse(message.body);
                    handleGlobalStatusChange(messageData);
                });

                // é€šçŸ¥ä¼ºæœå™¨ç”¨æˆ¶å·²ä¸Šç·š
                stompClient.send("/app/chat.addUser", {}, JSON.stringify({
                    username: currentUser
                }));

            }, function(error) {
                console.error('å…¨å±€ WebSocket é€£æ¥éŒ¯èª¤:', error);
            });
        }

        // è™•ç†å…¨å±€ç‹€æ…‹è®ŠåŒ–
        function handleGlobalStatusChange(messageData) {
            console.log('æ”¶åˆ°å…¨å±€ç‹€æ…‹è®ŠåŒ–:', messageData);

            if (messageData.type === 'USER_ONLINE') {
                updateUserStatus(messageData.username, true);
            } else if (messageData.type === 'USER_OFFLINE') {
                updateUserStatus(messageData.username, false);
            }
        }

        // æ›´æ–°é é¢ä¸­çš„ç”¨æˆ¶ç‹€æ…‹é¡¯ç¤º
        function updateUserStatus(username, isOnline) {
            // æ›´æ–°èŠå¤©å¤¥ä¼´åˆ—è¡¨ä¸­çš„ç‹€æ…‹
            const chatItems = document.querySelectorAll('.chat-item');
            chatItems.forEach(item => {
                const nameElement = item.querySelector('.chat-name');
                const statusElement = item.querySelector('.chat-status');

                if (nameElement && nameElement.textContent.includes(username)) {
                    if (statusElement) {
                        statusElement.textContent = isOnline ? 'ç·šä¸Š' : 'é›¢ç·š';
                        statusElement.style.color = isOnline ? '#28a745' : '#6c757d';
                    }
                }
            });
        }

        // é é¢é—œé–‰å‰çš„æ¸…ç†
        window.addEventListener('beforeunload', function() {
            if (stompClient && stompClient.connected) {
                stompClient.send("/app/chat.removeUser", {}, JSON.stringify({
                    username: currentUser
                }));
                stompClient.disconnect();
            }
        });

        // é é¢è¼‰å…¥æ™‚ç²å–é€šçŸ¥
        document.addEventListener('DOMContentLoaded', function() {
            // å»¶é²ä¸€ç§’åˆå§‹åŒ– WebSocketï¼Œç¢ºä¿é é¢è¼‰å…¥å®Œæˆ
            setTimeout(initializeGlobalStatus, 1000);
            loadInvitationNotifications();

            // å®šæœŸæª¢æŸ¥é€£æ¥ç‹€æ…‹
            setInterval(function() {
                if (!stompClient || !stompClient.connected) {
                    console.log('æª¢æ¸¬åˆ°å…¨å±€é€£æ¥æ–·é–‹ï¼Œå˜—è©¦é‡æ–°é€£æ¥...');
                    initializeGlobalStatus();
                }
                loadInvitationNotifications();
            }, 30000); // æ¯30ç§’æª¢æŸ¥ä¸€æ¬¡
        });
    </script>
</body>
</html>