<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${chatType == 'group' ? 'ç¾¤çµ„èŠå¤© - ' + group.name : 'ç§äººèŠå¤©'}"></title>
    <link rel="stylesheet" href="/css/chat.css">
</head>
<body>
<div class="chat-container">
    <!-- å·¦å´é¢æ¿ -->
    <div class="users-panel" th:if="${chatType == 'private'}">
        <!-- åŸæœ‰çš„ç§äººèŠå¤©ç”¨æˆ¶åˆ—è¡¨ -->
        <div class="user-header">
            <div class="current-user-info">
                <div class="current-user-avatar">
                    <img th:src="${currentUser.avatarUrl != null ? '/uploads/avatars/' + currentUser.avatarUrl.substring(currentUser.avatarUrl.lastIndexOf('/') + 1) : '/images/default-avatar.png'}"
                         alt="æˆ‘çš„é ­åƒ" class="avatar-img">
                </div>
                <div class="current-user-details">
                    <span class="current-user-name" th:text="${currentUser.displayName}"></span>
                    <div class="user-actions">
                        <a href="/home" class="profile-btn">é¦–é </a>
                        <a href="/profile" class="profile-btn">ç·¨è¼¯è³‡æ–™</a>
                        <a href="/logout" class="logout-btn">ç™»å‡º</a>
                    </div>
                </div>
            </div>
            <h3>ç·šä¸Šç”¨æˆ¶</h3>
        </div>
        <div class="users-list" id="usersList">
            <div th:each="user : ${users}"
                 th:if="${user.username != currentUser.username}"
                 class="user-item"
                 th:data-username="${user.username}"
                 th:onclick="'selectUser(this)'">
                <div class="user-avatar">
                    <img th:src="${user.avatarUrl != null ? '/uploads/avatars/' + user.avatarUrl.substring(user.avatarUrl.lastIndexOf('/') + 1) : '/images/default-avatar.png'}"
                         alt="ç”¨æˆ¶é ­åƒ" class="avatar-img">
                    <div class="online-indicator" th:classappend="${user.online ? 'online' : 'offline'}"></div>
                </div>
                <div class="user-info">
                    <div class="user-name" th:text="${user.displayName}"></div>
                    <div class="user-status" th:text="${user.online ? 'ç·šä¸Š' : 'é›¢ç·š'}"></div>
                    <div class="user-bio" th:if="${user.bio != null and !user.bio.isEmpty()}"
                         th:text="${user.bio.length() > 30 ? user.bio.substring(0, 30) + '...' : user.bio}"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- ç¾¤çµ„æˆå“¡é¢æ¿ -->
    <div class="users-panel" th:if="${chatType == 'group'}">
        <div class="user-header">
            <div class="group-info">
                <!-- ä¿®å¾©ç¾¤çµ„é ­åƒé¡¯ç¤ºï¼Œèª¿æ•´å°ºå¯¸ -->
                <img th:src="${group.avatarUrl != null and !#strings.isEmpty(group.avatarUrl) ?
                         (group.avatarUrl.startsWith('/uploads/') ? group.avatarUrl : '/uploads/groups/' + group.avatarUrl.substring(group.avatarUrl.lastIndexOf('/') + 1)) :
                         '/images/default-group.png'}"
                     alt="ç¾¤çµ„é ­åƒ"
                     class="group-avatar"
                     style="width: 60px !important; height: 60px !important; border-radius: 50% !important; object-fit: cover !important; border: 3px solid white !important;"
                     onerror="this.src='/images/default-group.png'; console.log('ç¾¤çµ„é ­åƒè¼‰å…¥å¤±æ•—ï¼Œä½¿ç”¨é è¨­åœ–ç‰‡');">
                <div class="group-details">
                    <h3 th:text="${group.name}"></h3>
                    <p th:text="${group.members.size()} + ' ä½æˆå“¡'"></p>
                    <div class="group-actions">
                        <a href="/home" class="profile-btn">é¦–é </a>
                        <a th:if="${group.creator.username == currentUser.username}"
                           th:href="@{/groups/{id}/settings(id=${group.id})}"
                           class="profile-btn">è¨­å®š</a>
                        <a href="/logout" class="logout-btn">ç™»å‡º</a>
                    </div>
                </div>
            </div>
        </div>
        <div class="users-list">
            <!-- ä¿®å¾©ç¾¤çµ„æˆå“¡é ­åƒé¡¯ç¤º -->
            <div th:each="member : ${group.members}" class="user-item">
                <div class="user-avatar">
                    <!-- æ”¹é€²çš„é ­åƒURLè™•ç†é‚è¼¯ -->
                    <img th:src="${member.avatarUrl != null and !#strings.isEmpty(member.avatarUrl) ?
                             (member.avatarUrl.startsWith('/uploads/') ? member.avatarUrl : '/uploads/avatars/' + member.avatarUrl.substring(member.avatarUrl.lastIndexOf('/') + 1)) :
                             '/images/default-avatar.png'}"
                         alt="æˆå“¡é ­åƒ"
                         class="avatar-img"
                         onerror="this.src='/images/default-avatar.png'; console.log('æˆå“¡é ­åƒè¼‰å…¥å¤±æ•—: ' + this.getAttribute('alt'));"
                         onload="console.log('æˆå“¡é ­åƒè¼‰å…¥æˆåŠŸ: ' + this.src);">
                    <div class="online-indicator" th:classappend="${member.online ? 'online' : 'offline'}"></div>
                </div>
                <div class="user-info">
                    <div class="user-name" th:text="${member.displayName}"></div>
                    <div class="user-status">
                        <span th:if="${group.creator.equals(member)}" class="creator-badge">å‰µå»ºè€…</span>
                        <span th:unless="${group.creator.equals(member)}"
                              th:text="${member.online ? 'ç·šä¸Š' : 'é›¢ç·š'}"
                              th:class="${member.online ? 'online-status' : 'offline-status'}"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å³å´èŠå¤©å€åŸŸ -->
    <div class="chat-panel">
        <div class="chat-header" id="chatHeader">
            <div th:if="${chatType == 'private'}">
                <h3>é¸æ“‡ä¸€å€‹ç”¨æˆ¶é–‹å§‹èŠå¤©</h3>
            </div>
            <div th:if="${chatType == 'group'}" class="group-chat-header">
                <!-- ä¿®å¾©å³å´èŠå¤©æ¨™é¡Œçš„ç¾¤çµ„é ­åƒé¡¯ç¤º -->
                <img th:src="${group.avatarUrl != null and !#strings.isEmpty(group.avatarUrl) ?
                         (group.avatarUrl.startsWith('/uploads/') ? group.avatarUrl : '/uploads/groups/' + group.avatarUrl.substring(group.avatarUrl.lastIndexOf('/') + 1)) :
                         '/images/default-group.png'}"
                     alt="ç¾¤çµ„é ­åƒ"
                     class="chat-header-avatar"
                     style="width: 40px !important; height: 40px !important; border-radius: 50% !important; object-fit: cover !important; border: 2px solid #667eea !important; margin-right: 15px !important;"
                     onerror="this.src='/images/default-group.png'; console.log('èŠå¤©æ¨™é¡Œç¾¤çµ„é ­åƒè¼‰å…¥å¤±æ•—');">
                <div class="chat-header-info">
                    <h3 th:text="${group.name}"></h3>
                    <p th:text="${group.members.size()} + ' ä½æˆå“¡'"></p>
                </div>
                <div class="group-actions" style="margin-left: auto; display: flex; gap: 0.5rem;">
                    <!-- åªæœ‰ç¾¤çµ„æˆå“¡å¯ä»¥çœ‹åˆ°é‚€è«‹æŒ‰éˆ• -->
                    <button onclick="openInviteModal()" class="btn btn-outline btn-sm" title="é‚€è«‹æˆå“¡">
                        ğŸ‘¥ é‚€è«‹
                    </button>
                    <!-- å‰µå»ºè€…æ‰èƒ½çœ‹åˆ°è¨­å®šæŒ‰éˆ• -->
                    <a th:if="${group.creator.username == currentUser.username}"
                       th:href="@{/groups/{id}/settings(id=${group.id})}"
                       class="btn btn-secondary btn-sm" title="ç¾¤çµ„è¨­å®š">
                        âš™ï¸ è¨­å®š
                    </a>
                </div>
            </div>
        </div>

        <!-- é‚€è«‹å½ˆçª— -->
        <div id="inviteModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h4>é‚€è«‹æˆå“¡åŠ å…¥ç¾¤çµ„</h4>
                    <span class="close" onclick="closeInviteModal()">&times;</span>
                </div>
                <div class="modal-body">
                    <div class="search-container">
                        <input type="text" id="modalUserSearch" class="user-search"
                               placeholder="æœå°‹ç”¨æˆ¶åæˆ–é¡¯ç¤ºåç¨±..." autocomplete="off">
                        <div class="search-results" id="modalSearchResults"></div>
                    </div>
                    <div class="form-group">
                        <label for="modalInviteMessage">é‚€è«‹è¨Šæ¯ï¼ˆå¯é¸ï¼‰</label>
                        <textarea id="modalInviteMessage" class="invite-message"
                                  placeholder="æ­¡è¿åŠ å…¥æˆ‘å€‘çš„ç¾¤çµ„ï¼"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button onclick="closeInviteModal()" class="btn btn-secondary">å–æ¶ˆ</button>
                    <button onclick="sendModalInvitation()" class="btn btn-primary" id="modalInviteBtn" disabled>
                        ç™¼é€é‚€è«‹
                    </button>
                </div>
            </div>
        </div>

        <div class="messages-container" id="messagesContainer">
            <!-- è¨Šæ¯æœƒåœ¨é€™è£¡é¡¯ç¤º -->
        </div>

        <div class="message-input-container"
             th:style="${chatType == 'group' ? 'display: block;' : 'display: none;'}"
             id="messageInputContainer">
            <div class="message-input">
                <input type="text" id="messageInput" placeholder="è¼¸å…¥è¨Šæ¯..." />
                <button id="sendButton">ç™¼é€</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
<script th:inline="javascript">
    var currentUser = /*[[${currentUser.username}]]*/ '';
    var currentUserDisplayName = /*[[${currentUser.displayName}]]*/ '';
    var currentUserAvatar = /*[[${currentUser.avatarUrl != null ? '/uploads/avatars/' + currentUser.avatarUrl.substring(currentUser.avatarUrl.lastIndexOf('/') + 1) : '/images/default-avatar.png'}]]*/ '';
    var chatType = /*[[${chatType}]]*/ 'private';
    var groupId = /*[[${group?.id}]]*/ null;
    var groupName = /*[[${group?.name}]]*/ null;
</script>
<script src="/js/chat.js"></script>
</body>
</html>