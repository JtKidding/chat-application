<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¾¤çµ„è¨­å®š - <span th:text="${group.name}"></span></title>
    <link rel="stylesheet" href="/css/group-settings.css">
    <style>
        /* é‚€è«‹åŠŸèƒ½ç›¸é—œæ¨£å¼ */
        .invite-section {
            background: linear-gradient(135deg, #e3f2fd 0%, #f0f8ff 100%);
            border: 1px solid #bbdefb;
        }

        .invite-form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .search-container {
            position: relative;
        }

        .user-search {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 1rem;
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e1e8ed;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .search-result-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            cursor: pointer;
            border-bottom: 1px solid #f1f3f4;
        }

        .search-result-item:hover {
            background: #f8f9fa;
        }

        .search-result-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            object-fit: cover;
        }

        .search-result-info {
            flex: 1;
        }

        .search-result-name {
            font-weight: 600;
            color: #333;
        }

        .search-result-username {
            font-size: 0.9rem;
            color: #666;
        }

        .invite-message {
            resize: vertical;
            min-height: 80px;
        }

        .pending-invitations {
            margin-top: 1.5rem;
        }

        .invitation-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: white;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            border: 1px solid #e1e8ed;
        }

        .invitation-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex: 1;
        }

        .invitation-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        .invitation-details {
            flex: 1;
        }

        .invitation-name {
            font-weight: 600;
            color: #333;
        }

        .invitation-time {
            font-size: 0.8rem;
            color: #666;
        }

        .invitation-status {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-accepted {
            background: #d4edda;
            color: #155724;
        }

        .status-declined {
            background: #f8d7da;
            color: #721c24;
        }

        .status-expired {
            background: #e2e3e5;
            color: #495057;
        }
    </style>
</head>
<body>
<div class="settings-container">
    <!-- é ‚éƒ¨å°èˆª -->
    <nav class="top-nav">
        <div class="nav-left">
            <a th:href="@{/group/{id}(id=${group.id})}" class="back-btn">â† è¿”å›èŠå¤©</a>
            <h2>ç¾¤çµ„è¨­å®š</h2>
        </div>
    </nav>

    <!-- æˆåŠŸ/éŒ¯èª¤è¨Šæ¯ -->
    <div th:if="${success}" class="success-message" th:text="${success}"></div>
    <div th:if="${error}" class="error-message" th:text="${error}"></div>

    <div class="settings-content">
        <!-- é‚€è«‹æˆå“¡å€åŸŸ -->
        <section class="settings-section invite-section">
            <h3>é‚€è«‹æˆå“¡</h3>
            <div class="invite-form">
                <div class="search-container">
                    <input type="text" id="userSearch" class="user-search"
                           placeholder="æœå°‹ç”¨æˆ¶åæˆ–é¡¯ç¤ºåç¨±..."
                           autocomplete="off">
                    <div class="search-results" id="searchResults"></div>
                </div>

                <div class="form-group">
                    <label for="inviteMessage">é‚€è«‹è¨Šæ¯ï¼ˆå¯é¸ï¼‰</label>
                    <textarea id="inviteMessage" class="invite-message"
                              placeholder="æ­¡è¿åŠ å…¥æˆ‘å€‘çš„ç¾¤çµ„ï¼"></textarea>
                </div>

                <button type="button" onclick="sendInvitation()" class="btn btn-primary" id="inviteBtn" disabled>
                    ç™¼é€é‚€è«‹
                </button>
            </div>

            <!-- å¾…è™•ç†é‚€è«‹åˆ—è¡¨ -->
            <div class="pending-invitations">
                <h4>å¾…è™•ç†é‚€è«‹</h4>
                <div id="pendingInvitationsList">
                    <!-- é‚€è«‹åˆ—è¡¨æœƒåœ¨é€™è£¡å‹•æ…‹è¼‰å…¥ -->
                </div>
            </div>
        </section>

        <!-- åŸæœ‰çš„å…¶ä»–è¨­å®šå€åŸŸä¿æŒä¸è®Š -->
        <!-- ç¾¤çµ„è³‡è¨Šå€åŸŸ -->
        <section class="settings-section">
            <h3>ç¾¤çµ„é ­åƒ</h3>
            <div class="avatar-section">
                <div class="current-avatar">
                    <img th:src="${group.avatarUrl != null ? '/uploads/groups/' + group.avatarUrl.substring(group.avatarUrl.lastIndexOf('/') + 1) : '/images/default-group.png'}"
                         alt="ç¾¤çµ„é ­åƒ" class="avatar-preview" id="avatarPreview">
                </div>
                <div class="avatar-controls">
                    <form th:action="@{/groups/{id}/upload-avatar(id=${group.id})}"
                          method="post" enctype="multipart/form-data" class="upload-form">
                        <input type="file" id="avatarInput" name="avatar" accept="image/*" style="display: none;">
                        <button type="button" onclick="document.getElementById('avatarInput').click()"
                                class="btn btn-primary">é¸æ“‡æ–°é ­åƒ</button>
                        <button type="submit" class="btn btn-success" id="uploadBtn" style="display: none;">
                            ä¸Šå‚³
                        </button>
                    </form>
                </div>
            </div>
        </section>

        <!-- åŸºæœ¬è¨­å®š -->
        <section class="settings-section">
            <h3>åŸºæœ¬è¨­å®š</h3>
            <form th:action="@{/groups/{id}/update(id=${group.id})}" method="post" class="settings-form">
                <div class="form-group">
                    <label for="name">ç¾¤çµ„åç¨± *</label>
                    <input type="text" id="name" name="name" th:value="${group.name}" required maxlength="50">
                </div>

                <div class="form-group">
                    <label for="description">ç¾¤çµ„æè¿°</label>
                    <textarea id="description" name="description" rows="3"
                              maxlength="200" th:text="${group.description}"></textarea>
                </div>

                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" name="isPrivate" value="true"
                               th:checked="${group.private}">
                        <span class="checkmark"></span>
                        <div class="checkbox-content">
                            <strong>ç§äººç¾¤çµ„</strong>
                            <p>åªæœ‰å—é‚€ç”¨æˆ¶æ‰èƒ½åŠ å…¥</p>
                        </div>
                    </label>
                </div>

                <button type="submit" class="btn btn-primary">æ›´æ–°è¨­å®š</button>
            </form>
        </section>

        <!-- ç¾¤çµ„çµ±è¨ˆ -->
        <section class="settings-section">
            <h3>ç¾¤çµ„çµ±è¨ˆ</h3>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" th:text="${groupStats.memberCount}"></div>
                    <div class="stat-label">æˆå“¡æ•¸é‡</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" th:text="${groupStats.messageCount}"></div>
                    <div class="stat-label">è¨Šæ¯ç¸½æ•¸</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" th:text="${#temporals.format(groupStats.createdAt, 'MM/dd')}"></div>
                    <div class="stat-label">å‰µå»ºæ—¥æœŸ</div>
                </div>
            </div>
        </section>

        <!-- æˆå“¡ç®¡ç† -->
        <section class="settings-section">
            <h3>æˆå“¡ç®¡ç†</h3>
            <div class="members-list">
                <div th:each="member : ${group.members}" class="member-item">
                    <div class="member-info">
                        <img th:src="${member.avatarUrl != null ? '/uploads/avatars/' + member.avatarUrl.substring(member.avatarUrl.lastIndexOf('/') + 1) : '/images/default-avatar.png'}"
                             alt="é ­åƒ" class="member-avatar">
                        <div class="member-details">
                            <div class="member-name" th:text="${member.displayName}"></div>
                            <div class="member-status">
                                <span th:if="${group.creator.equals(member)}" class="creator-badge">å‰µå»ºè€…</span>
                                <span th:unless="${group.creator.equals(member)}"
                                      th:text="${member.online ? 'ç·šä¸Š' : 'é›¢ç·š'}"
                                      th:class="${member.online ? 'online-status' : 'offline-status'}"></span>
                            </div>
                        </div>
                    </div>

                    <div class="member-actions" th:unless="${group.creator.equals(member)}">
                        <button class="btn btn-danger btn-sm remove-member-btn"
                                th:data-user-id="${member.id}"
                                th:data-user-name="${member.displayName}">ç§»é™¤</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- å±éšªå€åŸŸ -->
        <section class="settings-section danger-section">
            <h3>å±éšªæ“ä½œ</h3>
            <div class="danger-actions">
                <div class="danger-item">
                    <div class="danger-info">
                        <h4>è§£æ•£ç¾¤çµ„</h4>
                        <p>æ°¸ä¹…åˆªé™¤é€™å€‹ç¾¤çµ„å’Œæ‰€æœ‰èŠå¤©è¨˜éŒ„</p>
                    </div>
                    <button onclick="confirmDissolve()" class="btn btn-danger">è§£æ•£ç¾¤çµ„</button>
                </div>
            </div>
        </section>
    </div>
</div>

<script th:inline="javascript">
    // ä½¿ç”¨ Thymeleaf å…§è¯ JavaScript ä¾†ç²å–ç¾¤çµ„è³‡è¨Š
    var groupId = /*[[${group.id}]]*/ null;
    var groupName = /*[[${group.name}]]*/ '';
    var selectedUser = null; // é¸ä¸­è¦é‚€è«‹çš„ç”¨æˆ¶

    // é‚€è«‹åŠŸèƒ½ç›¸é—œè®Šæ•¸
    let searchTimeout;

    // é é¢è¼‰å…¥æ™‚çš„åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        // è¼‰å…¥å¾…è™•ç†é‚€è«‹
        loadPendingInvitations();

        // è¨­ç½®æœå°‹è¼¸å…¥äº‹ä»¶
        const userSearch = document.getElementById('userSearch');
        userSearch.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            const query = this.value.trim();

            if (query.length >= 2) {
                searchTimeout = setTimeout(() => searchUsers(query), 300);
            } else {
                hideSearchResults();
            }
        });

        // é»æ“Šå¤–éƒ¨éš±è—æœå°‹çµæœ
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.search-container')) {
                hideSearchResults();
            }
        });

        // ç‚ºæ‰€æœ‰ç§»é™¤æˆå“¡æŒ‰éˆ•æ·»åŠ é»æ“Šäº‹ä»¶
        const removeBtns = document.querySelectorAll('.remove-member-btn');
        removeBtns.forEach(function(btn) {
            btn.addEventListener('click', function() {
                const userId = this.getAttribute('data-user-id');
                const userName = this.getAttribute('data-user-name');
                removeMember(userId, userName);
            });
        });
    });

    // æœå°‹ç”¨æˆ¶
    function searchUsers(query) {
        fetch(`/api/invitations/search-users?query=${encodeURIComponent(query)}&groupId=${groupId}`)
            .then(response => response.json())
            .then(users => {
                displaySearchResults(users);
            })
            .catch(error => {
                console.error('æœå°‹ç”¨æˆ¶å¤±æ•—:', error);
            });
    }

    // é¡¯ç¤ºæœå°‹çµæœ
    function displaySearchResults(users) {
        const resultsContainer = document.getElementById('searchResults');

        if (users.length === 0) {
            resultsContainer.innerHTML = '<div style="padding: 1rem; text-align: center; color: #666;">æ²’æœ‰æ‰¾åˆ°åŒ¹é…çš„ç”¨æˆ¶</div>';
        } else {
            resultsContainer.innerHTML = users.map(user => `
                    <div class="search-result-item" onclick="selectUser(${user.id}, '${user.username}', '${user.displayName}', '${user.avatarUrl}')">
                        <img src="${user.avatarUrl}" alt="é ­åƒ" class="search-result-avatar">
                        <div class="search-result-info">
                            <div class="search-result-name">${user.displayName}</div>
                            <div class="search-result-username">@${user.username}</div>
                        </div>
                        ${user.isOnline ? '<span style="color: #28a745;">â—</span>' : '<span style="color: #6c757d;">â—</span>'}
                    </div>
                `).join('');
        }

        resultsContainer.style.display = 'block';
    }

    // é¸æ“‡ç”¨æˆ¶
    function selectUser(id, username, displayName, avatarUrl) {
        selectedUser = { id, username, displayName, avatarUrl };
        document.getElementById('userSearch').value = `${displayName} (@${username})`;
        document.getElementById('inviteBtn').disabled = false;
        hideSearchResults();
    }

    // éš±è—æœå°‹çµæœ
    function hideSearchResults() {
        document.getElementById('searchResults').style.display = 'none';
    }

    // ç™¼é€é‚€è«‹
    function sendInvitation() {
        if (!selectedUser) {
            alert('è«‹å…ˆé¸æ“‡è¦é‚€è«‹çš„ç”¨æˆ¶');
            return;
        }

        const message = document.getElementById('inviteMessage').value.trim();
        const inviteBtn = document.getElementById('inviteBtn');

        // ç¦ç”¨æŒ‰éˆ•
        inviteBtn.textContent = 'ç™¼é€ä¸­...';
        inviteBtn.disabled = true;

        const requestData = {
            groupId: groupId,
            inviteeUsername: selectedUser.username,
            message: message
        };

        fetch('/api/invitations/send', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestData)
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`é‚€è«‹å·²ç™¼é€çµ¦ ${selectedUser.displayName}`);
                    // é‡ç½®è¡¨å–®
                    document.getElementById('userSearch').value = '';
                    document.getElementById('inviteMessage').value = '';
                    selectedUser = null;
                    // é‡æ–°è¼‰å…¥å¾…è™•ç†é‚€è«‹
                    loadPendingInvitations();
                } else {
                    alert('ç™¼é€é‚€è«‹å¤±æ•—: ' + data.error);
                }
            })
            .catch(error => {
                console.error('ç™¼é€é‚€è«‹éŒ¯èª¤:', error);
                alert('ç™¼é€é‚€è«‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
            })
            .finally(() => {
                // æ¢å¾©æŒ‰éˆ•
                inviteBtn.textContent = 'ç™¼é€é‚€è«‹';
                inviteBtn.disabled = selectedUser === null;
            });
    }

    // è¼‰å…¥å¾…è™•ç†é‚€è«‹
    function loadPendingInvitations() {
        fetch(`/api/invitations/group/${groupId}`)
            .then(response => response.json())
            .then(invitations => {
                displayPendingInvitations(invitations.filter(inv => inv.status === 'PENDING'));
            })
            .catch(error => {
                console.error('è¼‰å…¥é‚€è«‹å¤±æ•—:', error);
            });
    }

    // é¡¯ç¤ºå¾…è™•ç†é‚€è«‹
    function displayPendingInvitations(invitations) {
        const container = document.getElementById('pendingInvitationsList');

        if (invitations.length === 0) {
            container.innerHTML = '<p style="color: #666; text-align: center; padding: 1rem;">ç›®å‰æ²’æœ‰å¾…è™•ç†çš„é‚€è«‹</p>';
            return;
        }

        container.innerHTML = invitations.map(invitation => `
                <div class="invitation-item">
                    <div class="invitation-info">
                        <img src="${invitation.invitee.avatarUrl}" alt="é ­åƒ" class="invitation-avatar">
                        <div class="invitation-details">
                            <div class="invitation-name">${invitation.invitee.displayName}</div>
                            <div class="invitation-time">é‚€è«‹æ–¼ ${new Date(invitation.createdAt).toLocaleString('zh-TW')}</div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <span class="invitation-status status-${invitation.status.toLowerCase()}">${getStatusText(invitation.status)}</span>
                        <button onclick="cancelInvitation(${invitation.id})" class="btn btn-danger btn-sm">å–æ¶ˆ</button>
                    </div>
                </div>
            `).join('');
    }

    // å–æ¶ˆé‚€è«‹
    function cancelInvitation(invitationId) {
        if (!confirm('ç¢ºå®šè¦å–æ¶ˆé€™å€‹é‚€è«‹å—ï¼Ÿ')) {
            return;
        }

        fetch(`/api/invitations/${invitationId}/cancel`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('é‚€è«‹å·²å–æ¶ˆ');
                    loadPendingInvitations();
                } else {
                    alert('å–æ¶ˆé‚€è«‹å¤±æ•—: ' + data.error);
                }
            })
            .catch(error => {
                console.error('å–æ¶ˆé‚€è«‹éŒ¯èª¤:', error);
                alert('å–æ¶ˆé‚€è«‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
            });
    }

    // ç²å–ç‹€æ…‹æ–‡å­—
    function getStatusText(status) {
        const statusMap = {
            'PENDING': 'å¾…è™•ç†',
            'ACCEPTED': 'å·²æ¥å—',
            'DECLINED': 'å·²æ‹’çµ•',
            'EXPIRED': 'å·²éæœŸ',
            'CANCELLED': 'å·²å–æ¶ˆ'
        };
        return statusMap[status] || status;
    }

    // åŸæœ‰çš„å…¶ä»–å‡½æ•¸ä¿æŒä¸è®Š...

    // é ­åƒé è¦½åŠŸèƒ½
    document.getElementById('avatarInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('avatarPreview').src = e.target.result;
            };
            reader.readAsDataURL(file);
            document.getElementById('uploadBtn').style.display = 'inline-block';
        }
    });

    // ç§»é™¤æˆå“¡åŠŸèƒ½
    function removeMember(userId, userName) {
        console.log('æº–å‚™ç§»é™¤æˆå“¡:', userId, userName);

        if (confirm(`ç¢ºå®šè¦å°‡ ${userName} ç§»å‡ºç¾¤çµ„å—ï¼Ÿ`)) {
            const btn = document.querySelector(`[data-user-id="${userId}"]`);
            if (btn) {
                btn.textContent = 'è™•ç†ä¸­...';
                btn.disabled = true;
            }

            fetch(`/api/groups/${groupId}/members/${userId}/remove`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
                .then(response => {
                    console.log('API å›æ‡‰ç‹€æ…‹:', response.status);

                    if (response.ok) {
                        alert(`${userName} å·²è¢«ç§»å‡ºç¾¤çµ„`);
                        location.reload();
                    } else {
                        return response.text().then(text => {
                            throw new Error(`ç§»é™¤æˆå“¡å¤±æ•—: ${response.status} - ${text}`);
                        });
                    }
                })
                .catch(error => {
                    console.error('ç§»é™¤æˆå“¡éŒ¯èª¤:', error);
                    alert('ç§»é™¤æˆå“¡å¤±æ•—: ' + error.message);

                    if (btn) {
                        btn.textContent = 'ç§»é™¤';
                        btn.disabled = false;
                    }
                });
        }
    }

    // ç¢ºèªè§£æ•£ç¾¤çµ„
    function confirmDissolve() {
        if (confirm(`âš ï¸ ç¢ºå®šè¦è§£æ•£ç¾¤çµ„ã€Œ${groupName}ã€å—ï¼Ÿ\n\næ­¤æ“ä½œå°‡æœƒï¼š\nâ€¢ æ°¸ä¹…åˆªé™¤ç¾¤çµ„\nâ€¢ åˆªé™¤æ‰€æœ‰èŠå¤©è¨˜éŒ„\nâ€¢ ç§»é™¤æ‰€æœ‰æˆå“¡\nâ€¢ ç„¡æ³•å¾©åŸ\n\nè«‹æ…é‡è€ƒæ…®ï¼`)) {
            const userConfirmation = prompt(`è«‹è¼¸å…¥ç¾¤çµ„åç¨±ã€Œ${groupName}ã€ä¾†ç¢ºèªè§£æ•£æ“ä½œï¼š`);
            if (userConfirmation !== groupName) {
                if (userConfirmation !== null) {
                    alert('âŒ ç¾¤çµ„åç¨±ä¸æ­£ç¢ºï¼Œè§£æ•£æ“ä½œå·²å–æ¶ˆ');
                }
                return;
            }

            if (confirm(`ğŸš¨ æœ€å¾Œç¢ºèª\n\næ‚¨å³å°‡è§£æ•£ç¾¤çµ„ã€Œ${groupName}ã€\n\né€™å€‹æ“ä½œç„¡æ³•æ’¤éŠ·ï¼Œæ‰€æœ‰æ•¸æ“šå°‡æ°¸ä¹…ä¸Ÿå¤±ï¼\n\nç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ`)) {
                dissolveGroup();
            }
        }
    }

    // åŸ·è¡Œè§£æ•£ç¾¤çµ„
    function dissolveGroup() {
        const dissolveBtn = document.querySelector('button[onclick="confirmDissolve()"]');
        if (dissolveBtn) {
            dissolveBtn.textContent = 'è§£æ•£ä¸­...';
            dissolveBtn.disabled = true;
            dissolveBtn.style.opacity = '0.5';
        }

        showLoadingMessage('æ­£åœ¨è§£æ•£ç¾¤çµ„ï¼Œè«‹ç¨å€™...');

        fetch(`/api/groups/${groupId}/dissolve`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
            .then(response => {
                console.log('è§£æ•£ç¾¤çµ„ API å›æ‡‰ç‹€æ…‹:', response.status);

                if (response.ok) {
                    return response.json().then(data => {
                        console.log('è§£æ•£ç¾¤çµ„æˆåŠŸ:', data);
                        hideLoadingMessage();
                        alert(`âœ… ${data.message || 'ç¾¤çµ„å·²æˆåŠŸè§£æ•£'}`);
                        window.location.href = '/groups';
                    });
                } else {
                    return response.json().then(errorData => {
                        throw new Error(errorData.error || `è§£æ•£å¤±æ•—: HTTP ${response.status}`);
                    }).catch(() => {
                        throw new Error(`è§£æ•£å¤±æ•—: HTTP ${response.status}`);
                    });
                }
            })
            .catch(error => {
                console.error('è§£æ•£ç¾¤çµ„éŒ¯èª¤:', error);
                hideLoadingMessage();

                if (dissolveBtn) {
                    dissolveBtn.textContent = 'è§£æ•£ç¾¤çµ„';
                    dissolveBtn.disabled = false;
                    dissolveBtn.style.opacity = '1';
                }

                alert('âŒ è§£æ•£ç¾¤çµ„å¤±æ•—: ' + error.message);
            });
    }

    // é¡¯ç¤ºè¼‰å…¥è¨Šæ¯
    function showLoadingMessage(message) {
        hideLoadingMessage();

        const loadingDiv = document.createElement('div');
        loadingDiv.id = 'loading-message';
        loadingDiv.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(0, 0, 0, 0.8);
                color: white;
                padding: 20px 30px;
                border-radius: 10px;
                z-index: 10000;
                font-size: 16px;
                text-align: center;
            `;
        loadingDiv.innerHTML = `
                <div style="margin-bottom: 10px;">â³</div>
                <div>${message}</div>
            `;

        document.body.appendChild(loadingDiv);
    }

    // éš±è—è¼‰å…¥è¨Šæ¯
    function hideLoadingMessage() {
        const loadingDiv = document.getElementById('loading-message');
        if (loadingDiv) {
            loadingDiv.remove();
        }
    }
</script>
</body>
</html>